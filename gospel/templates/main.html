{% extends 'wrapper.html' %}
{% load static %}
{% block main %}
    {% load common %}
    <div class="">
        <h2>Православный церковный календарь. Месяцеслов</h2>
        <div class="bd-content p-3">
            <blockquote class="blockquote text-right">
                {% for q in quote %}
                <p class="mb-0"><strong class="text-danger">{{ q.num }}</strong> {{ q.text }}</p>
                <footer class="blockquote-footer">Глава {{ q.chapter.num }} <cite><a href="{% url 'lines' %}?b={{ q.chapter.book.short_title }}&r={{ q.chapter.num }},{{ q.num }}&full=1">{{ q.chapter.book.title }}</a></cite></footer>
                {% endfor %}
            </blockquote>
        </div>
        <div id="carousel" class="carousel slide" data-interval="">
            <div class="clearfix">
                <a class="float-left" href="#carousel" role="button" data-slide="prev">Вчера</a>
                <a class="float-right" href="#carousel" role="button" data-slide="next">Завтра</a>
            </div>
            <div class="carousel-inner">
                {% for days in prevdays %}
                <div class="carousel-item" data-loaded="false" data-days="{{ days }}"></div>
                {% endfor %}
                <div class="carousel-item active" data-loaded="true">
                    <div class="">Сегодня, <span class="text-muted"><em>{{ today_old }}</em></span> / <em>{{ today }}</em>, {{ today|date:"l" }}</div>
                    <div class="trapeza">
                        <div class="trapeza-img tr-{{ calendar.trapeza_id }}"></div>
                        <p class="lead">{{ calendar.trapeza }}</p>
                    </div>
                    {% if calendar.saints or calendar.title %}
                    <h5>Церковь почитает и вспоминает</h5>
                    <div class="card border-warning">
                        <div class="card-body">
                            {% if calendar.title %}
                                {% for t in calendar.title %}
                                <div class="text-center alert alert-success" role="alert">
                                    {{ t|safe }}
                                </div>
                                {% endfor %}
                            {% endif %}
                            <div id="days0" class="float-left mr-3 mb-3"></div>
                            {% if calendar.saints %}
                                <div>
                                {% for s in calendar.saints %}
                                <p>{{ s|safe }}</p>
                                {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    <div class="reading mb-4">
                    <h4 class="mt-4">Чтение за Богослужением</h4>
                        {% for refs in calendar.reading %}
                            {% for s in refs %}
                                <span>{{ s|safe }}</span>
                            {% endfor %}
                        {% endfor %}
                    </div>
                    <div class="mb-5">
                        {% for name, prays in calendar.prayers.items %}
                        {% if prays %}
                            <h5>{{ name|safe }}</h5>
                            {% for pray in prays %}
                            <p class="lead">{{ pray|safe }}</p>
                            {% endfor %}
                        {% endif %}
                        {% endfor %}
                        <h5>Молитва о восстановлении мира</h5>
                        <div>
                        <p class="lead">Владыко Многомилостиве Господи, Иисусе Христе, Боже наш, молитвами Всепречистыя Владычицы нашея Богородицы и Приснодевы Марии, святых равноапостольных великого князя Владимира и великия княгини Ольги, святых Новомучеников и исповедников Церкви нашея, преподобных и богоносных отец наших Антония и Феодосия, Киево-Печерских чудотворцев, Сергия, игумена Радонежского, Иова Почаевского, Серафима Саровского и всех святых, благоприятну сотвори молитву нашу о Церкви и о всех людех Твоих.</p>
                        <p class="lead">От единыя купели Крещения, еже при святем князе Владимире, мы, чада Твои, благодать восприяхом, — дух братолюбия и мира в сердцах наших навеки утверди!</p>
                        <p class="lead">Иноплеменным же языком, брани хотящим и на Святую Русь ополчающимся, — запрети и замыслы их ниспровергни.</p>
                        <p class="lead">Благодатию Твоею власть предержащих ко всякому благу настави, воинов — в заповедях Твоих утверди, лишенныя крова — в домы введи, голодныя — напитай, недугующая и страждущая — укрепи и исцели, в смятении и печали сущим — надежду благую и утешение подаждь, на брани убиенным — прощение грехов и блаженное упокоение сотвори.</p>
                        <p class="lead">Исполни нас яже в Тя веры, надежды и любве, яко да во всех странах наших единеми усты и единем сердцем исповемыся Тебе, Господу и Спасителю нашему Иисусу Христу, со Безначальным Твоим Отцем, Пресвятым Благим и Животворящим Твоим Духом во веки веков. Аминь.</p>
                        </div>
                    </div>
                    <blockquote class="blockquote">
                        {% for s in calendar.preaching %}
                        <p>{{ s|safe }}</p>
                        {% endfor %}
                    </blockquote>
                    {% if calendar.feofan %}
                    <blockquote class="blockquote">
                        <h4 class="text-center mt-5 mb-4">Святитель Феофан Затворник. Мысли на каждый день года</h4>
                        <div class="float-left mr-3"><img src="{% static 'img/Feofan.jpg' %}" /></div>
                        <div>
                        {{ calendar.feofan|safe }}
                        </div>
                    </blockquote>
                    {% endif %}
                </div>
                {% for days in nextdays %}
                <div class="carousel-item" data-loaded="false" data-days="{{ days }}"></div>
                {% endfor %}
            </div>
        </div>
        {% if next %}
        <div class="text-right">
            <div><em>Далее</em></div>
            <p><strong>{% for t in next.data.title %}{{ t|safe }}{% endfor %}</strong></p>
            <p class="text-muted">
                <em>
                {% if next.days %}
                через {{ next.days }} {{ next.days|declension:"день,дня,дней" }},
                {% else %}
                завтра,
                {% endif %}
                </em>
                {{ next.date }}
            </p>
        </div>
        {% endif %}
        <div id="calendar-month"></div>
        <div class="mt-5 mb-5">
            <div>
                Ежедневное чтение Библии:
                <a href="/reading/pub/?g=zYHsuT6n" class="badge badge-success">сегодня</a>
                <a href="/reading/pub/queue/?g=zYHsuT6n" class="badge badge-secondary">последовательность чтения</a>
                <a href="/reading/pub/?g=zYHsuT6n&d=2025-08-12" class="badge badge-info">начало цикла 12 августа 2025 г.</a>
                <a href="/reading/new/?v=51" class="badge badge-warning">начать чтение с сегоднешнего дня</a>
            </div>
            <div class="text-muted"><small>Вся Библия прочитывается за 365 дней. Используется сборник <a href="/bible/volume/51/">Библия за год (azbyka.ru)</a>.</small></div>
            <div class="text-center"><a href="https://azbyka.ru/1/duhovnoe_chtenie" class="badge badge-warning" target="_blank">Как читать Библию</a></div>
        </div>
        {% if not user.is_authenticated %}
        <p class="lead">Вы можете <a href="{% url 'register' %}">зарегистрироваться</a>, чтобы участвовать в группах, или <a href="{% url 'login' %}">войдите</a>, чтобы продолжить чтение.</p>
        {% endif %}
    </div>
    <script>
    var TMSHIFT = 0;
    function dayiconloaded() {
        var _w = dayicon.w;
        var _h = dayicon.h;
        $("#days"+TMSHIFT).html(
            '<img src="'+dayicon.src+'" WIDTH='+_w+' HEIGHT='+_h+' ALT="'+dayicon.text+'" title="'+dayicon.text+'">'
        );
    }
    function loadDayIcon(tmshift) {
        var _sh24 = tmshift || 0;
        var _prev = 'dayiconscript'+TMSHIFT;
        var head = document.getElementsByTagName('head').item(0);
        var scriptTag = document.getElementById(_prev);
        if(scriptTag) head.removeChild(scriptTag);
        script = document.createElement('script');
        script.src = "https://script.pravoslavie.ru/icon.php?advanced=2&tmshift="+_sh24;
        script.type = 'text/javascript';
        script.id = 'dayiconscript' + _sh24;
        head.appendChild(script);
        TMSHIFT = _sh24;
    }
    var CAL_SHIFT_FORWARD_URL = '{% url "j-calendar-shift-forward" 777  %}';
    var CAL_SHIFT_BACKWARD_URL = '{% url "j-calendar-shift-backward" 777  %}';
    $(function() {
        loadDayIcon();
        $('.carousel').carousel({
            interval: 0
        });
        $('#carousel').on('slide.bs.carousel', function (e) {
            var targ$ = $(e.relatedTarget);
            if(!targ$.data("loaded")) {
                targ$.html('<div class="loading"></div>');
                var days = targ$.data("days");
                var _SHIFT = days*24;
                var URL = CAL_SHIFT_FORWARD_URL;
                if(e.direction === "right") {
                    URL = CAL_SHIFT_BACKWARD_URL;
                    _SHIFT = -1*days*24;
                }
                $.ajax({
                    type: "GET",
                    url: URL.replace(777, days),
                    dataType: "json",
                    success: function(data) {
                        var html = '<div class=""><span class="text-muted"><em>' + rus_date(getDate(data.old), true) + '</em></span> / <em>' + rus_date(getDate(data.today), true) + '</em>, ' + rus_date_day(getDate(data.today))+ '</div>';
                        html += '<div class="trapeza"><div class="trapeza-img tr-' + data.calendar.trapeza_id + '"></div><p class="lead">'+ data.calendar.trapeza +'</p></div>';
                        if(data.calendar.saints.length || data.calendar.title.length) {
                            html += '<h5>Церковь почитает и вспоминает</h5>';
                            html += '<div class="card border-warning"><div class="card-body">';
                            if(data.calendar.title.length) {
                                for(var i=0; i<data.calendar.title.length; i++) {
                                    html += '<div class="text-center alert alert-success" role="alert">' + data.calendar.title[i] + '</div>';
                                }
                            }
                            html += '<div id="days'+ _SHIFT +'" class="float-left mr-3 mb-3"></div>';
                            if(data.calendar.saints.length) {
                                html += '<div>';
                                for(var i=0; i<data.calendar.saints.length; i++) {
                                    html += '<p>'+ data.calendar.saints[i] +'</p>';
                                }
                                html += '</div>';
                            }
                            html += '</div></div>';
                        }
                        html += '<div class="reading mb-4">';
                        html+= '<h4 class="mt-4">Чтение за Богослужением</h4>';
                        for(var i=0; i<data.calendar.reading.length; i++) {
                            var refs = data.calendar.reading[i];
                            for(var j=0; j<refs.length; j++) {
                                html += '<span>'+ refs[j] +'</span>';
                            }
                        }
                        html += '</div>';
                        html += '<div class="mb-5">';
                        for(var name in data.calendar.prayers) {
                            var prays = data.calendar.prayers[name];
                            if(prays.length) {
                                html += '<h5>' + name + '</h5>';
                                for(var i=0; i<prays.length; i++) {
                                    html += '<p class="lead">' + prays[i] + '</p>';
                                }
                            }
                        }
                        html += '<h5>Молитва о восстановлении мира</h5><div><p class="lead">Владыко Многомилостиве Господи, Иисусе Христе, Боже наш, молитвами Всепречистыя Владычицы нашея Богородицы и Приснодевы Марии, святых равноапостольных великого князя Владимира и великия княгини Ольги, святых Новомучеников и исповедников Церкви нашея, преподобных и богоносных отец наших Антония и Феодосия, Киево-Печерских чудотворцев, Сергия, игумена Радонежского, Иова Почаевского, Серафима Саровского и всех святых, благоприятну сотвори молитву нашу о Церкви и о всех людех Твоих.</p><p class="lead">От единыя купели Крещения, еже при святем князе Владимире, мы, чада Твои, благодать восприяхом, — дух братолюбия и мира в сердцах наших навеки утверди!</p><p class="lead">Иноплеменным же языком, брани хотящим и на Святую Русь ополчающимся, — запрети и замыслы их ниспровергни.</p><p class="lead">Благодатию Твоею власть предержащих ко всякому благу настави, воинов — в заповедях Твоих утверди, лишенныя крова — в домы введи, голодныя — напитай, недугующая и страждущая — укрепи и исцели, в смятении и печали сущим — надежду благую и утешение подаждь, на брани убиенным — прощение грехов и блаженное упокоение сотвори.</p><p class="lead">Исполни нас яже в Тя веры, надежды и любве, яко да во всех странах наших единеми усты и единем сердцем исповемыся Тебе, Господу и Спасителю нашему Иисусу Христу, со Безначальным Твоим Отцем, Пресвятым Благим и Животворящим Твоим Духом во веки веков. Аминь.</p></div>'
                        html += '</div>';
                        html += '<blockquote class="blockquote">';
                        for(var i=0; i<data.calendar.preaching.length; i++) {
                            html += '<p>'+ data.calendar.preaching[i] +'</p>';
                        }
                        html += '</blockquote>';
                        if(data.calendar.feofan) {
                            html += '<blockquote class="blockquote">';
                            html += '<h4 class="text-center mt-5 mb-4">Святитель Феофан Затворник. Мысли на каждый день года</h4>';
                            html += '<div class="float-left mr-3"><img src="{% static 'img/Feofan.jpg' %}" /></div>';
                            html += '<div>' + data.calendar.feofan + '</div>';
                            html += '</blockquote>';
                        }
                        targ$.html(html);
                        targ$.data("loaded", true);
                        loadDayIcon(_SHIFT);
                    }
                });
            }
        });
        $("#carousel").swiperight(function() {
            $(this).carousel("prev");
        });
        $("#carousel").swipeleft(function() {
            $(this).carousel("next");
        });
    });
    </script>
{% endblock %}
